<!doctype html>
<html>
<head>
<title>I Spy Volleyball</title>
<style>
* {
  font-family: Helvetica;
  margin: 0px;
  padding: 0px;
}
#textarea {
  border: 1px solid blac;
  width: 100%;
  height: 300px;
  font-size: 20px;
  font-family: monospace;
}
</style>
<meta name = "viewport" content = "width = device-width, initial-scale=1, user-scalable=yes">
</head>
<body>
<textarea id=textarea>
set name drew
set age 29
list apples
   fuji
mac
end

scope bear
  set name twinkle
  set type toy
end

msg intro Hello my name is Drew LeSueur

msgl bio :)
this is my bio
it is pretty long
what do you thing of it
end :)

  msgl bio2 :o)
    this is my bio2.
    not quite as long
  end :o)

hash bear2
name sunshine
paws 4
end


</textarea>
<input type="button" value="Run" onclick="runCodeDom()"><br />
<canvas id=canvas></canvas>
<script>
var canvasEl = document.getElementById("canvas")
var textareaEl = document.getElementById("textarea")
var runCodeDom = function () {
  var code = textareaEl.value 
  return runCode(code)
}

var commands = {
  get_first_word_and_rest: function (line) {
    var firstSpace = line.indexOf(" ")
    if (firstSpace == -1) {
      firstSpace = line.length
    }
    var first = line.slice(0, firstSpace)
    var rest = line.slice(firstSpace + 1)
    return {
      first: first,
      rest: rest
    }
  },
  handle_normal_line: function (line, glbl) {
    glbl.raw_line = line
    line = line.trim()
    
    var first_and_rest = commands.get_first_word_and_rest(line)
    var command_name = first_and_rest.first
    var rest = first_and_rest.rest    
    var command = commands[command_name]
    if (!command) return null;
    if (command.is_custom) {
    
    } else {
      var ret = command(rest, glbl) 
      return ret  
    }
  },
  handle_list: function (line, glbl) {
    if (line.trim() == "end") {
      commands.handle_line = commands.handle_normal_line
      delete glbl.scope.__current_list
    } else {
      glbl.scope.__current_list.push(commands.get_cooked(line.trim(), glbl.scope))
    }
  },
  parse_line: function (words) {
    return words.split(" ") //for now
  },
  handle_hash: function (line, glbl) {
    if (line.trim() == "end") {
      commands.handle_line = commands.handle_normal_line
      delete glbl.scope.__current_hash
    } else {
      line = line.trim()
      var words = commands.parse_line(line)
      var key = words[0]
      var value = words[1]
      var value = commands.get_cooked(value, glbl.scope)
      glbl.scope.__current_hash[key] = value
    }
  },
  get_indent_count: function (line) { //my "indent" "mark8" project
    var ic = 0
    var line_len = line.length
    while (ic < line_len) {
      if (line.substr(ic,1) == " ") { ic++ } else { break }
    }
    return ic
  },
  handle_string: function (line, glbl) {
    if (line.trim() == "end " + glbl.scope.__special_text) {
      commands.handle_line = commands.handle_normal_line
      glbl.scope[glbl.scope.__current_string_name] = glbl.scope.__current_string_group.join("\n")
      delete glbl.scope.__special_text
      delete glbl.scope.__current_string_group
      delete glbl.scope.__current_string_name
      delete glbl.scope.__indent_count
      delete glbl.scope.__got_indent_count
    } else {
      if (glbl.scope.__got_indent_count) {
        if (glbl.scope.__indent_count) {
          line = line.slice(glbl.scope.__indent_count)
        }
      } else {
        glbl.scope.__indent_count = commands.get_indent_count(line)
        glbl.scope.__got_indent_count = true
        line = line.slice(glbl.scope.__indent_count)
      }
      glbl.scope.__current_string_group.push(line)
    }
  },
  msg: function (line, glbl) {
    var first_and_rest = commands.get_first_word_and_rest(line)     
    glbl.scope[first_and_rest.first] = first_and_rest.rest
  },
  msgl: function (line, glbl) {
    
    var first_and_rest = commands.get_first_word_and_rest(line)     
    var name = first_and_rest.first
    var special_text = first_and_rest.rest
    glbl.scope.__special_text = special_text
    glbl.scope.__current_string_group = []
    glbl.scope.__current_string_name = name
    commands.handle_line = commands.handle_string
  },
  list: function (line, glbl) {
    var list = []
    glbl.scope[line] = list
    glbl.scope.__current_list = list
    commands.handle_line = commands.handle_list
  },
  // idea: certain type of list where you can have nested things
  hash: function (line, glbl) {
    var hash = {}
    glbl.scope[line] = hash
    glbl.scope.__current_hash = hash
    commands.handle_line = commands.handle_hash
  },
  "end": function (line, glbl) {
    if (glbl.scope.parent_scope) {
      glbl.scope = glbl.scope.parent_scope
    } else {
      //nothing
    }
  },
  scope: function (line, glbl) {
    var new_scope = {}
    glbl.scope[line] = new_scope
    new_scope.parent_scope = glbl.scope
    glbl.scope = new_scope
  },
  set: function (line, glbl) { //raw
    var words = line.split(" ")
    var key = words[0]
    var value = commands.get_cooked(words[1], glbl.scope)
    commands.set_cooked(key, value, glbl.scope, glbl.scope) 
  },
  setl: function (line, glbl) { //raw
    var words = line.split(" ")
    var key = words[0]
    var value = commands.get_cooked(words[1], glbl.scope)
    commands.setl_cooked(key, value, glbl.scope, glbl.scope) 
  },
  set_cooked: function (key, value, scope, original_scope) {
    if (!original_scope) {
      original_scope = scope
    }
    if (key in scope) {
      scope[key] = value  
    } else if (scope.parent_scope) {
      return commands.set_cooked(key, value, scope.parent_scope, original_scope) 
    } else {
      original_scope[key] = value
    }
  },
  setl_cooked: function (key, value, scope, original_scope) {
    scope[key] = value  
  },
  get_cooked: function (key, scope) {
    if (key in scope) {
      return scope[key]
    } else if (scope.parent_scope){
      return commands.get_cooked(key, scope.parent_scope)  
    } else {
      return key;
    }
  }
}

commands.handle_line = commands.handle_normal_line


var runCode = function (code, scope) {
  scope = scope || {}
  var glbl = {}
  glbl.scope = scope
  lines = code.split("\n")
  for (var i = 0; i < lines.length; i++) {
    var line = lines[i]
    var ret = commands.handle_line(line, glbl)
    
  }
  console.log(glbl)
}



</script>
</body>
</html>

