<!doctype html>
<html>
<head>
<title>I Spy Volleyball</title>
<style>
* {
  font-family: Helvetica;
  margin: 0px;
  padding: 0px;
}
#textarea {
  border: 1px solid blac;
  width: 100%;
  height: 300px;
  font-size: 20px;
  font-family: monospace;
}
</style>
<meta name = "viewport" content = "width = device-width, initial-scale=1, user-scalable=yes">
</head>
<body>
<textarea id=textarea>
set name drew
set age 29
start_list apples
   fuji
mac
end

</textarea>
<input type="button" value="Run" onclick="runCodeDom()"><br />
<canvas id=canvas></canvas>
<script>
var canvasEl = document.getElementById("canvas")
var textareaEl = document.getElementById("textarea")
var runCodeDom = function () {
  var code = textareaEl.value 
  return runCode(code)
}

var commands = {
  handle_normal_line: function (line, glbl) {
    var firstSpace = line.indexOf(" ")
    if (firstSpace == -1) {
      firstSpace = line.length
    }
    var command_name = line.slice(0, firstSpace)
    var command = commands[command_name]
    if (!command) return null;
    if (command.is_custom) {
    
    } else {
      var rest = line.slice(firstSpace + 1)
      var ret = command(rest, glbl) 
      return ret  
    }
  },
  handle_list: function (line, glbl) {
    if (line.trim() == "end") {
      commands.handle_line = commands.handle_normal_line
      delete glbl.scope.__current_list
    } else {
      glbl.scope.__current_list.push(commands.get_cooked(line.trim(), glbl.scope))
    }
  },
  start_list: function (line, glbl) {
    var list = []
    glbl.scope[line] = list
    glbl.scope.__current_list = list
    commands.handle_line = commands.handle_list
  },
  "end": function (line, glbl) {
    if (glbl.scope.parent_scope) {
      glbl.scope = glbl.scope.parent_scope
    } else {
      //nothing
    }
  },
  start_scope: function (line, glbl) {
    var new_scope = {}
    glbl.scope[line] = new_scope
    new_scope.parent_scope = glbl.scope
    glbl.scope = new_scope
  },
  set: function (line, glbl) { //raw
    var words = line.split(" ")
    var key = words[0]
    var value = commands.get_cooked(words[1], glbl.scope)
    commands.set_cooked(key, value, glbl.scope, glbl.scope) 
  },
  setl: function (line, glbl) { //raw
    var words = line.split(" ")
    var key = words[0]
    var value = commands.get_cooked(words[1], glbl.scope)
    commands.setl_cooked(key, value, glbl.scope, glbl.scope) 
  },
  set_cooked: function (key, value, scope, original_scope) {
    if (!original_scope) {
      original_scope = scope
    }
    if (key in scope) {
      scope[key] = value  
    } else if (scope.parent_scope) {
      return commands.set_cooked(key, value, scope.parent_scope, original_scope) 
    } else {
      original_scope[key] = value
    }
  },
  setl_cooked: function (key, value, scope, original_scope) {
    scope[key] = value  
  },
  get_cooked: function (key, scope) {
    if (key in scope) {
      return scope[key]
    } else if (scope.parent_scope){
      return commands.get_cooked(key, scope.parent_scope)  
    } else {
      return key;
    }
  }
}

commands.handle_line = commands.handle_normal_line


var runCode = function (code, scope) {
  scope = scope || {}
  var glbl = {}
  glbl.scope = scope
  lines = code.split("\n")
  for (var i = 0; i < lines.length; i++) {
    var line = lines[i]
    var ret = commands.handle_line(line, glbl)
    
  }
  console.log(glbl)
}



</script>
</body>
</html>

